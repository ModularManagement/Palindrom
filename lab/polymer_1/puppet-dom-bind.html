<dom-module id="puppet-dom-bind">
    <script>
        Polymer({
            model: null,
            is: 'puppet-dom-bind',
            // Polymer's dom-bind:
            extends: 'template',
            created: function() {
                Polymer.ImportStatus.whenLoaded(this._readySelf.bind(this));
            },
            _registerFeatures: function() {
                this._prepConstructor();
            },
            _insertChildren: function() {
                var parentDom = Polymer.dom(Polymer.dom(this).parentNode);
                parentDom.insertBefore(this.root, this);
            },
            _removeChildren: function() {
                if (this._children) {
                    for (var i = 0; i < this._children.length; i++) {
                        this.root.appendChild(this._children[i]);
                    }
                }
            },
            _initFeatures: function() {},
            _scopeElementClass: function(element, selector) {
                if (this.dataHost) {
                    return this.dataHost._scopeElementClass(element, selector);
                } else {
                    return selector;
                }
            },
            _prepConfigure: function() {
                var config = {};
                for (var prop in this._propertyEffects) {
                    config[prop] = this[prop];
                }
                this._setupConfigure = this._setupConfigure.bind(this, config);
            },
            attached: function() {
                if (!this._children) {
                    this._template = this;
                    this._prepAnnotations();
                    this._prepEffects();
                    this._prepBehaviors();
                    this._prepConfigure();
                    this._prepBindings();
                    Polymer.Base._initFeatures.call(this);
                    this._children = Array.prototype.slice.call(this.root.childNodes);
                }
                this._insertChildren();
                this.fire('dom-change');
            },
            detached: function() {
                this._removeChildren();
            },
            // EO Polymer's dom-bind

            properties: {
                model: Object,
                puppet: {
                    type: Object,
                    value: null,
                    observer: "puppetChanged"
                }
            },
            puppetChanged: function(newValue, oldValue) {
                var that = this;

                this.model = newValue.obj;

                newValue.addEventListener("patchreceived", function(e) {
                    that.notifyPatches(e);
                });

                newValue.addEventListener("patchsent", function(e) {
                    that.notifyPatches(e);
                });
            },
            notifyPatches: function(e) {
                var that = this;

                //Setting timeout to don't apply changes before puppet applies it.
                setTimeout(function() {
                    var patches = JSON.parse(e.detail.data);

                    for (var i = 0; i < patches.length; i++) {
                        var patch = patches[i];
                        var path = patch.path;

                        //that.notifyPath("model" + path.replace(/[/]/gi, "."), patches[i].value);
                        that.notifyAll(patch.op, "model" + path.replace(/[/]/gi, "."), patches[i].value);
                    }
                });
            },
            notifyAll: function(operation, path, value) {
                var imports = document.querySelectorAll("puppet-import");

                //this.notifyPath(path, value);
                this.notifyPatch(this, operation, path, value);

                for (var i = 0; i < imports.length; i++) {
                    var t = imports[i].template;
                    var p = imports[i].path;

                    if (p) {
                        var reg = new RegExp("^" + p.replace(/\./gi, "\."), "gi");

                        if (reg.test(path)) {
                            p = path.replace(reg, "model");
                            //t.notifyPath(p, value);
                            this.notifyPatch(t, operation, path, value, p);
                        }
                    } else {
                        //t.notifyPath(path, value);
                        this.notifyPatch(t, operation, path, value);
                    }
                }
            },
            notifyPatch: function(element, operation, fullPath, value, elementPath) {
                element.notifyPath(elementPath || fullPath, value);

                if (operation == "add") {
                    var path = fullPath.replace(/[.][^.]+$/gi, "");
                    var v = this.getModelValue(path);

                    path = (elementPath || fullPath).replace(/[.][^.]+$/gi, "");
                    element.notifyPath(path, v.slice());
                }
            },
            getModelValue: function(path) {
                var parts = path.split(".");
                var v = this.model;

                for (var i = 1; i < parts.length; i++) {
                    v = v[parts[i]];
                }

                return v;
            }
        });
    </script>
</dom-module>
