<dom-module id="index-root">
    <template>
        <h1>{{model.text}}</h1>
        <p>{{model.message}}</p>
        <p>
            <template is="dom-repeat" items="{{getPages(model.currentPage)}}">
                <template is="dom-if" if="{{item.selected}}">
                    <span>{{item.name}}</span>
                </template>
                <template is="dom-if" if="{{!item.selected}}">
                    <a href="{{item.name}}">{{item.name}}</a>
                </template>
            </template>
        </p>
        <div>
            <button type="button" on-click="onClick">
                <span>Click me (<span>{{model.click$}}</span>)!</span>
            </button>
        </div>
    </template>
    <script>
        Polymer({
            is: "index-root",
            ready: function () {
                
            },
            properties: {
                model: Object,
                puppet: {
                    type: Object,
                    value: null,
                    observer: "puppetChanged"
                }
            },
            getPages: function (current) {
                var pages = ["index.html", "subpage.html"];
                var result = [];

                for (var i = 0; i < pages.length; i++) {
                    result.push({
                        name: pages[i],
                        selected: pages[i] == current
                    });
                }

                return result;
            },
            onClick: function () {
                this.set("model.click$", this.model.click$ + 1);
            },
            puppetChanged: function (newValue, oldValue) {
                var that = this;

                newValue.addEventListener("patchreceived", function (e) {
                    //Setting timeout to don't apply changes before puppet applies it.
                    setTimeout(function () {
                        var patches = JSON.parse(e.detail.data);

                        for (var i = 0; i < patches.length; i++) {
                            var path = patches[i].path;

                            if (/^[/]_ver/gi.test(path)) {
                                continue;
                            }

                            that.notifyPath("model" + path.replace(/[/]/gi, "."), patches[i].value);
                        }
                    });
                });
            }
        });
    </script>
</dom-module>